---
title: "Entrega2_Proyecto1"
author: "Gustavo Cruz; Pedro Guzman"
date: "2025-02-12"
output: html_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "docs/index.html") })
---

```{r}
movies <- read.csv('movies.csv', stringsAsFactors = FALSE)
```
## Determinación de la cantidad de grupos
```{r}
library(tidyverse)
library(cluster)
library(factoextra)

# Función para remover outliers usando IQR
remove_outliers <- function(x) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm=TRUE)
  H <- 1.5 * IQR(x, na.rm=TRUE)
  x[x < (qnt[1] - H)] <- NA
  x[x > (qnt[2] + H)] <- NA
  return(x)
}

movies_clean <- movies %>%
  select(popularity, budget, revenue, runtime, 
         genresAmount, productionCoAmount, 
         productionCountriesAmount, voteCount, 
         voteAvg, actorsAmount, 
         castWomenAmount, castMenAmount) %>%
  mutate(across(everything(), as.numeric)) %>%
  # Remover outliers
  mutate(across(everything(), remove_outliers)) %>%
  # Eliminar filas con NA
  na.omit()

movies_scaled <- scale(movies_clean)

set.seed(531) # Seed para reproducibilidad
wss <- numeric(12)  
for (k in 1:12) {
  km <- kmeans(movies_scaled, 
               centers = k, 
               nstart = 50,  
               iter.max = 50)  
  wss[k] <- km$tot.withinss
}

p <- fviz_nbclust(movies_scaled, 
             kmeans, 
             method = "wss",
             k.max = 12,  
             nstart = 50,  
             iter.max = 50) +  
  labs(title = "Método del Codo para Determinar k Óptimo",
       x = "Número de Clusters (k)",
       y = "Suma total de cuadrados dentro de clusters") +
  theme_minimal()

print(p)

wss_diff <- diff(wss) / wss[-length(wss)] * 100
print("\nReducción porcentual en WSS para cada k adicional:")
for(i in 1:length(wss_diff)) {
  cat(sprintf("De %d a %d clusters: %.2f%% de reducción\n", 
              i, i+1, abs(wss_diff[i])))
}
```
## Agrupamiento

```{r}
# Para el ejercicio 2 de clustering estare utilizando la seed 531
movies_clean <- movies %>%
  select(popularity, budget, revenue, runtime, 
         genresAmount, productionCoAmount, 
         productionCountriesAmount, voteCount, 
         voteAvg, actorsAmount, 
         castWomenAmount, castMenAmount) %>%
  mutate(across(everything(), as.numeric)) %>%
  mutate(across(everything(), remove_outliers)) %>%
  na.omit()

movies_scaled <- scale(movies_clean)

set.seed(531)
kmeans_result <- kmeans(movies_scaled, 
                       centers = 4, 
                       nstart = 50,
                       iter.max = 50)

set.seed(531)
sample_size <- min(1000, nrow(movies_scaled))
sample_indices <- sample(1:nrow(movies_scaled), sample_size)
movies_sample <- movies_scaled[sample_indices, ]

dist_matrix <- dist(movies_sample, method = "euclidean")
hclust_result <- hclust(dist_matrix, method = "ward.D2")
hclust_clusters <- cutree(hclust_result, k = 4)

silhouette_kmeans <- silhouette(kmeans_result$cluster, 
                               dist(movies_scaled))
sil_score_kmeans <- mean(silhouette_kmeans[,3])

silhouette_hclust <- silhouette(hclust_clusters, dist_matrix)
sil_score_hclust <- mean(silhouette_hclust[,3])

cat("\nComparación de Algoritmos de Clustering:\n")
cat("\nK-means:")
cat("\n- Número de observaciones por cluster:\n")
print(table(kmeans_result$cluster))
cat("\n- Coeficiente de silueta promedio:", round(sil_score_kmeans, 3))

cat("\n\nClustering Jerárquico (muestra de", sample_size, "observaciones):")
cat("\n- Número de observaciones por cluster:\n")
print(table(hclust_clusters))
cat("\n- Coeficiente de silueta promedio:", round(sil_score_hclust, 3))

pca_result <- prcomp(movies_scaled)
cluster_plot <- data.frame(
  PC1 = pca_result$x[,1],
  PC2 = pca_result$x[,2],
  Cluster = as.factor(kmeans_result$cluster)
)

ggplot(cluster_plot, aes(x = PC1, y = PC2, color = Cluster)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Visualización de Clusters K-means",
       x = "Primera Componente Principal",
       y = "Segunda Componente Principal")
```

## Interpretacion de los resultados

```{r}
movies_clean$cluster <- as.factor(kmeans_result$cluster)

# Estadísticas descriptivas por cluster
cluster_stats <- movies_clean %>%
  group_by(cluster) %>%
  summarise(
    n = n(),
    # Medidas de tendencia central
    avg_budget = mean(budget, na.rm = TRUE),
    avg_revenue = mean(revenue, na.rm = TRUE),
    avg_runtime = mean(runtime, na.rm = TRUE),
    avg_popularity = mean(popularity, na.rm = TRUE),
    avg_vote = mean(voteAvg, na.rm = TRUE),
    avg_vote_count = mean(voteCount, na.rm = TRUE),
    avg_actors = mean(actorsAmount, na.rm = TRUE),
    avg_women = mean(castWomenAmount, na.rm = TRUE),
    avg_men = mean(castMenAmount, na.rm = TRUE),
    # Medidas de dispersión
    sd_budget = sd(budget, na.rm = TRUE),
    sd_revenue = sd(revenue, na.rm = TRUE),
    # Métricas derivadas
    roi = (mean(revenue, na.rm = TRUE) - mean(budget, na.rm = TRUE)) / mean(budget, na.rm = TRUE)
  )

print("Análisis de Clusters:")
print(cluster_stats)

# Presupuesto vs Ingresos
ggplot(movies_clean, aes(x = budget, y = revenue, color = cluster)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Presupuesto vs Ingresos por Cluster",
       x = "Presupuesto",
       y = "Ingresos")

# Popularidad vs Calificación promedio
ggplot(movies_clean, aes(x = popularity, y = voteAvg, color = cluster)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Popularidad vs Calificación por Cluster",
       x = "Popularidad",
       y = "Calificación Promedio")
```

###Interpretación de los Grupos y Hallazgos
Distribución de los Clusters (K-means)

La distribución de clusters ordenadas de mayor a menor, me dio lo siguiente:

  Cluster 4: 2,513 películas (45.6%), representando la mayoría de las producciones con características promedio.
  Cluster 1: 1,315 películas (24.0%), con características que se desvían moderadamente del estándar.
    Cluster 3: 873 películas (15.9%), probablemente películas independientes o de menor inversión.
    Cluster 2: 796 películas (14.5%), caracterizadas por mayor presupuesto e impacto en la industria.

####Calidad del Agrupamiento

El coeficiente de silueta obtenido fue de 0.145 para K-means y 0.105 para clustering jerárquico. Aunque ambos valores son relativamente bajos, K-means mostró una mejor separación de grupos, lo que justifica su uso en la interpretación.
Análisis Visual mediante PCA

- Cluster 4 se encuentra en una posición central y densa, lo que sugiere que representa la categoría más común de películas.
- Cluster 2 se extiende hacia la derecha, indicando valores elevados en ciertas métricas.
- Cluster 3 se agrupa en la parte inferior del espacio PCA, reflejando un presupuesto menor.
- Cluster 1 presenta una distribución más dispersa, lo que sugiere una mayor variabilidad en sus características.

#### Relevancia para la Industria

Los resultados reflejan una estructura de mercado donde:

- La mayoría de las películas siguen un patrón estándar (Cluster 4).
- Las superproducciones representan un segmento más reducido pero influyente (Cluster 2).
- Existe un mercado intermedio de películas con impacto moderado (Cluster 1).
- Se mantiene un sector significativo de producciones de menor presupuesto (Cluster 3).




