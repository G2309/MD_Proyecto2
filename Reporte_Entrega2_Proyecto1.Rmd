---
title: "Entrega2_Proyecto1"
author: "Gustavo Cruz; Pedro Guzman"
date: "2025-02-12"
output: html_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "docs/index.html") })
---

```{r}
movies <- read.csv('movies.csv', stringsAsFactors = FALSE)
```
## Determinación de la cantidad de grupos
```{r}
library(tidyverse)
library(cluster)
library(factoextra)

# Función para remover outliers usando IQR
remove_outliers <- function(x) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm=TRUE)
  H <- 1.5 * IQR(x, na.rm=TRUE)
  x[x < (qnt[1] - H)] <- NA
  x[x > (qnt[2] + H)] <- NA
  return(x)
}

movies_clean <- movies %>%
  select(popularity, budget, revenue, runtime, 
         genresAmount, productionCoAmount, 
         productionCountriesAmount, voteCount, 
         voteAvg, actorsAmount, 
         castWomenAmount, castMenAmount) %>%
  mutate(across(everything(), as.numeric)) %>%
  # Remover outliers
  mutate(across(everything(), remove_outliers)) %>%
  # Eliminar filas con NA
  na.omit()

movies_scaled <- scale(movies_clean)

set.seed(531) # Seed para reproducibilidad
wss <- numeric(12)  
for (k in 1:12) {
  km <- kmeans(movies_scaled, 
               centers = k, 
               nstart = 50,  
               iter.max = 50)  
  wss[k] <- km$tot.withinss
}

p <- fviz_nbclust(movies_scaled, 
             kmeans, 
             method = "wss",
             k.max = 12,  
             nstart = 50,  
             iter.max = 50) +  
  labs(title = "Método del Codo para Determinar k Óptimo",
       x = "Número de Clusters (k)",
       y = "Suma total de cuadrados dentro de clusters") +
  theme_minimal()

print(p)

wss_diff <- diff(wss) / wss[-length(wss)] * 100
print("\nReducción porcentual en WSS para cada k adicional:")
for(i in 1:length(wss_diff)) {
  cat(sprintf("De %d a %d clusters: %.2f%% de reducción\n", 
              i, i+1, abs(wss_diff[i])))
}
```
## Agrupamiento

```{r}
# Para el ejercicio 2 de clustering estare utilizando la seed 531
movies_clean <- movies %>%
  select(popularity, budget, revenue, runtime, 
         genresAmount, productionCoAmount, 
         productionCountriesAmount, voteCount, 
         voteAvg, actorsAmount, 
         castWomenAmount, castMenAmount) %>%
  mutate(across(everything(), as.numeric)) %>%
  mutate(across(everything(), remove_outliers)) %>%
  na.omit()

movies_scaled <- scale(movies_clean)

set.seed(531)
kmeans_result <- kmeans(movies_scaled, 
                       centers = 4, 
                       nstart = 50,
                       iter.max = 50)

set.seed(531)
sample_size <- min(1000, nrow(movies_scaled))
sample_indices <- sample(1:nrow(movies_scaled), sample_size)
movies_sample <- movies_scaled[sample_indices, ]

dist_matrix <- dist(movies_sample, method = "euclidean")
hclust_result <- hclust(dist_matrix, method = "ward.D2")
hclust_clusters <- cutree(hclust_result, k = 4)

silhouette_kmeans <- silhouette(kmeans_result$cluster, 
                               dist(movies_scaled))
sil_score_kmeans <- mean(silhouette_kmeans[,3])

silhouette_hclust <- silhouette(hclust_clusters, dist_matrix)
sil_score_hclust <- mean(silhouette_hclust[,3])

cat("\nComparación de Algoritmos de Clustering:\n")
cat("\nK-means:")
cat("\n- Número de observaciones por cluster:\n")
print(table(kmeans_result$cluster))
cat("\n- Coeficiente de silueta promedio:", round(sil_score_kmeans, 3))

cat("\n\nClustering Jerárquico (muestra de", sample_size, "observaciones):")
cat("\n- Número de observaciones por cluster:\n")
print(table(hclust_clusters))
cat("\n- Coeficiente de silueta promedio:", round(sil_score_hclust, 3))

pca_result <- prcomp(movies_scaled)
cluster_plot <- data.frame(
  PC1 = pca_result$x[,1],
  PC2 = pca_result$x[,2],
  Cluster = as.factor(kmeans_result$cluster)
)

ggplot(cluster_plot, aes(x = PC1, y = PC2, color = Cluster)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Visualización de Clusters K-means",
       x = "Primera Componente Principal",
       y = "Segunda Componente Principal")
```

## 



